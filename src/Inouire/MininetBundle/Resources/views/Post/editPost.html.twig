{% extends 'InouireMininetBundle:Default:base.html.twig' %}

{% block title %}édition de post{% endblock %}


{% block body %}

    {% include 'InouireMininetBundle:Default:blankBlock.html.twig' %}
    
    <div class="row post-editor" id={{post.id}}>
        
        <div class="span2" style="text-align: center;">
            {% if post.published %}
                <h4>{{ post.date | localeDate('medium','none',null,'dd MMMM Y') }}</h4>
                <span class="label label-success">publié</span>
            {% else %}
                <h4>Aujourd'hui</h4>
                <span class="label label-warning">non publié</span>
            {% endif %}
            <br /><br />
            <img id="loading-wheel" src="{{ asset('/css/icons/loading.gif')}}" style="display: none"/>
        </div>
        
        <div class="span9">
        
            <form method="post" action="{{ path('update_post') }}" id="{{ post.id }}" {{ form_enctype(post_form) }}>
            
                {{ form_errors(post_form) }}
                
            {% if post.published == true %}
                <button class="btn btn-danger pull-left" id="delete-button" name="submitButton" value="delete"><i class="icon-trash icon-white" id="delete-icon"></i> Supprimer</a></button>
                <button class="btn btn-success pull-right" type="submit" name="submitButton" value="update"><i class="icon-download icon-white" id="publish-icon"></i> Mettre à jour</button>
            {% else %}
                <button class="btn" id="save-button" type="submit" name="submitButton" value="save"><i class="icon-download" id="save-icon"></i> 
                    <span class="hidden-phone">Garder comme brouillon</span>
                    <span class="visible-phone">Sauver</span>
                </button>
                <button class="btn btn-success pull-right" id="publish-button" type="submit" name="submitButton" value="publish"><i class="icon-download icon-white" id="publish-icon"></i> Publier</button>
            {% endif %}
                
                <br /><br />
                {{ form_widget(
                    post_form.content, {'attr': {'style':'width:100%','rows':'10'} })
                }}

                {{ form_rest(post_form) }}
            </form>
        </div>
    </div>
    
    <center>
        <button class="btn btn-primary" id="add-image-button" ><i class="icon-picture icon-white"></i> Ajouter une photo</button>
        <form action="{{ path('add_image') }}" id="image-upload-form" method="post" {{ form_enctype(form) }} style="display: none">
            {{ form_errors(form) }}
            <div>
                {{ form_errors(form.file) }}
                {{ form_widget(form.file) }}
            </div>
            {{ form_rest(form) }}
            <input type="submit" id="image-upload-submit" class="btn"/>
        </form>
        <br /><br />
    </center>
    
    {% if post.hasImages %}
    <div class="row">
        <div class="span9 offset2">
            <ul class="thumbnails">
                {% for image in post.images %}

                <li class="span3" id="image-{{image.id}}">
                    <div class="thumbnail">
                        <a href="{{path('rotate_image',{'image_id':image.id,'direction':'counter-clockwise'})}}"><img src="{{asset('css/icons/rotate-ccw.png')}}"/></a>
                        <span class="text-align:center"></span>
                        <a href="{{path('rotate_image',{'image_id':image.id,'direction':'clockwise'})}}" class="pull-right"><img src="{{asset('css/icons/rotate-cw.png')}}"/></a>
                        <img src="{{ image.webpath | imagine_filter('big_thumb') }}" />
                        <i class="icon-trash delete-image-button" id="{{image.id}}"></i>
                    </div>
                </li>
                
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        jQuery(document).ready(function(){
            
            function disableAllControls(){
                $('#delete-button').addClass('disabled');
                $('#publish-button').addClass('disabled');
                $('#save-button').addClass('disabled');
                $('#add-image-button').addClass('disabled');
                $('#loading-wheel').fadeIn(100);
            }
  
            function deleteImageAjax(image_id){
                console.log("ACTION: delete image "+image_id);
                if(confirm("Êtes vous sur de vouloir supprimer cette photo ?")){
                    $.ajax({
                        url : '/image/'+image_id,
                        type : 'DELETE',
                        dataType : 'json',
                        success : function(data, statut){
                            console.log("Axaj call has been a success");
                            console.log(data);
                            $('#image-'+image_id).fadeOut(400);
                        },
                        error : function(data, statut, error){
                            console.log("Error during ajax call");
                        },
                    });
                }
            }
            
            
            //adding listener on "delete post" button to display a warning
            var deleteActionLocked = true;
            $('#delete-button').click( function (event) {
                if(deleteActionLocked == true){
                    event.preventDefault();
                    if(confirm("Êtes vous sur de vouloir supprimer définitivement cet article ?\n(les commentaires ainsi que les photos attachées seront perdus)")){
                        deleteActionLocked = false;
                        $('#delete-button').click(); 
                    }
                }
            });

            //adding listener on "add image" button
            $("#add-image-button").click( function (event) {
                $('#image-upload-form').fadeIn(400);
                updatePostAjax(0);
                $('input[type=file]').click();
            });

            //adding listener on "submit file" button
            $("#image-upload-submit").click( function (event) {
                disableAllControls(true);
            });

            //adding listeners on "delete image" icons
            $(".delete-image-button").click( function (event) {
                var image_id = event.target.id;
                deleteImageAjax(image_id);
            });
            
            //adding listener on all out links
            /*$("a").click( function (event) {
                event.preventDefault();
                requestedLink = $(this).attr('href');
                updatePostAjax(0,redirect_to_path(requestedLink));
            });*/
            
            $(":submit").click( function (event) {
                disableAllControls();
            });
            

        });
    </script>
{% endblock %}

